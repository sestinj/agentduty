#!/bin/sh
# AgentDuty CLI installer
# Usage: curl -fsSL https://agentduty.dev/install | sh

set -e

REPO="sestinj/agentduty"
BINARY_NAME="agentduty"
INSTALL_DIR="/usr/local/bin"
FALLBACK_DIR="$HOME/.local/bin"

# Colors (only if terminal supports them)
if [ -t 1 ]; then
  RED='\033[0;31m'
  GREEN='\033[0;32m'
  YELLOW='\033[0;33m'
  BOLD='\033[1m'
  RESET='\033[0m'
else
  RED=''
  GREEN=''
  YELLOW=''
  BOLD=''
  RESET=''
fi

info() {
  printf "${BOLD}%s${RESET}\n" "$1"
}

success() {
  printf "${GREEN}%s${RESET}\n" "$1"
}

warn() {
  printf "${YELLOW}%s${RESET}\n" "$1"
}

error() {
  printf "${RED}Error: %s${RESET}\n" "$1" >&2
  exit 1
}

# Detect OS
detect_os() {
  case "$(uname -s)" in
    Linux*)  echo "linux" ;;
    Darwin*) echo "darwin" ;;
    *)       error "Unsupported operating system: $(uname -s). AgentDuty supports Linux and macOS." ;;
  esac
}

# Detect architecture
detect_arch() {
  case "$(uname -m)" in
    x86_64|amd64)  echo "amd64" ;;
    aarch64|arm64)  echo "arm64" ;;
    *)              error "Unsupported architecture: $(uname -m). AgentDuty supports amd64 and arm64." ;;
  esac
}

# Check for required commands
check_deps() {
  for cmd in curl; do
    if ! command -v "$cmd" >/dev/null 2>&1; then
      error "'$cmd' is required but not found. Please install it and try again."
    fi
  done
}

# Determine install directory
get_install_dir() {
  if [ -w "$INSTALL_DIR" ]; then
    echo "$INSTALL_DIR"
  else
    mkdir -p "$FALLBACK_DIR" 2>/dev/null || error "Cannot create directory $FALLBACK_DIR"
    echo "$FALLBACK_DIR"
  fi
}

main() {
  info "Installing AgentDuty CLI..."
  echo ""

  check_deps

  OS="$(detect_os)"
  ARCH="$(detect_arch)"
  info "Detected: ${OS}/${ARCH}"

  DOWNLOAD_URL="https://github.com/${REPO}/releases/latest/download/${BINARY_NAME}-${OS}-${ARCH}"

  DIR="$(get_install_dir)"
  TARGET="${DIR}/${BINARY_NAME}"

  info "Downloading from ${DOWNLOAD_URL}..."

  HTTP_CODE=$(curl -fsSL -w '%{http_code}' -o "$TARGET" "$DOWNLOAD_URL" 2>/dev/null) || true

  if [ ! -f "$TARGET" ] || [ "$(wc -c < "$TARGET" | tr -d ' ')" -lt 1000 ]; then
    rm -f "$TARGET" 2>/dev/null
    error "Download failed. Check that the release exists at:\n  ${DOWNLOAD_URL}\n\nIf this is a new installation, releases may not be published yet.\nVisit https://github.com/${REPO}/releases for available versions."
  fi

  chmod +x "$TARGET"

  # Verify it runs
  if ! "$TARGET" --version >/dev/null 2>&1; then
    # Binary might not support --version yet, that's okay
    info "Installed (version check skipped)"
  else
    VERSION=$("$TARGET" --version 2>/dev/null || echo "unknown")
    info "Version: ${VERSION}"
  fi

  echo ""
  success "AgentDuty CLI installed to ${TARGET}"

  # Check if install dir is in PATH
  case ":$PATH:" in
    *":${DIR}:"*) ;;
    *)
      echo ""
      warn "Note: ${DIR} is not in your PATH."
      echo "Add it by running:"
      echo ""
      echo "  export PATH=\"${DIR}:\$PATH\""
      echo ""
      echo "Or add that line to your shell profile (~/.bashrc, ~/.zshrc, etc.)"
      ;;
  esac

  echo ""
  info "Get started:"
  echo "  ${BINARY_NAME} login"
  echo "  ${BINARY_NAME} notify -m \"Hello from AgentDuty\""
  echo ""
}

main
